name: rehab-plan-generator # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆã‚³ãƒ³ãƒ†ãƒŠåã®æ¥é ­è¾ã«ãªã‚Šã¾ã™ï¼‰

services: # ã“ã“ã«èµ·å‹•ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ç¾¤ã‚’å®šç¾©ã—ã¾ã™
  # ----------------------------------------------------------------
  # ğŸ˜ Database: PostgreSQL + pgvector
  # ----------------------------------------------------------------
  # åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã®ä¸­é–“DBãŠã‚ˆã³ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
  db:
    image: pgvector/pgvector:pg16 # æ‹¡å¼µæ©Ÿèƒ½(pgvector)ãŒå…¥ã£ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³
    container_name: rpg-db
    restart: always
    # ãƒãƒ¼ãƒˆå…¬é–‹(ports)ã¯å‰Šé™¤ã—ã€å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ã¨ã™ã‚‹
    environment:
      POSTGRES_USER: ${DB_USER}     # .envã‹ã‚‰èª­ã¿è¾¼ã¿
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      TZ: Asia/Tokyo
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d # åˆæœŸåŒ–SQL (pgvectoræœ‰åŠ¹åŒ–)
    networks:
      - rpg-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------
  # ğŸ Backend: Python (FastAPI)
  # ----------------------------------------------------------------
  # APIã‚µãƒ¼ãƒãƒ¼ãŠã‚ˆã³ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rpg-backend
    restart: always
    # portsã¨volumes(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰åŒæœŸ)ã‚’å‰Šé™¤
    volumes:
      - ./logs/app:/var/log/app
    environment:
      DATABASE_URL: postgresql+asyncpg://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
      ENV: ${ENV}
    depends_on:
      db:
        condition: service_healthy
    # æœ¬ç•ªç”¨ã‚³ãƒãƒ³ãƒ‰: ãƒªãƒ­ãƒ¼ãƒ‰ãªã—
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - rpg-network

  # ----------------------------------------------------------------
  # âš›ï¸ Frontend: React + TypeScript (Vite)
  # ----------------------------------------------------------------
  # UIã‚’æä¾›ã—ã¾ã™ã€‚
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rpg-frontend
    restart: always
    # portsã‚’å‰Šé™¤
    environment:
      - NODE_ENV=production
    # æœ¬ç•ªç”¨ã‚³ãƒãƒ³ãƒ‰ (Viteã®previewæ©Ÿèƒ½ãªã©)
    command: npm run preview -- --host
    networks:
      - rpg-network

  # ----------------------------------------------------------------
  # ğŸŒ Nginx: Reverse Proxy
  # ----------------------------------------------------------------
  # å”¯ä¸€å¤–éƒ¨(ãƒ›ã‚¹ãƒˆ)ã¨é€šä¿¡ã™ã‚‹ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤
  nginx:
    image: nginx:alpine
    container_name: rpg-nginx
    ports:
      - "80:80"
      # æœ¬ç•ªã§SSLåŒ–ã™ã‚‹å ´åˆã¯ã“ã“ã« "443:443" ã‚’è¿½åŠ 
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./frontend/public/libs:/usr/share/nginx/html/libs # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé…ä¿¡
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - rpg-network

volumes: # ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€å®šç¾©
  db_data: # DBãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

networks: # ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã®é€šä¿¡ç¶²å®šç¾©
  rpg-network:
    driver: bridge