name: rehab-plan-generator # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆã‚³ãƒ³ãƒ†ãƒŠåã®æ¥é ­è¾ã«ãªã‚Šã¾ã™ï¼‰

services: # ã“ã“ã«èµ·å‹•ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ç¾¤ã‚’å®šç¾©ã—ã¾ã™
  # ----------------------------------------------------------------
  # ğŸ˜ Database: PostgreSQL + pgvector
  # ----------------------------------------------------------------
  # åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã®ä¸­é–“DBãŠã‚ˆã³ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
  db:
    image: pgvector/pgvector:pg16 # æ‹¡å¼µæ©Ÿèƒ½(pgvector)ãŒå…¥ã£ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³
    container_name: rpg-db
    restart: always
    ports:
      - "5432:5432" # é–‹ç™ºç”¨: ãƒ›ã‚¹ãƒˆã‹ã‚‰DBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ¥ç¶šå¯èƒ½ã«ã™ã‚‹
    environment:
      POSTGRES_USER: ${DB_USER:-user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_DB: ${DB_NAME:-rehab_db}
      TZ: Asia/Tokyo
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d # åˆæœŸåŒ–SQL (pgvectoræœ‰åŠ¹åŒ–)
    networks:
      - rpg-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-user} -d ${DB_NAME:-rehab_db}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------
  # ğŸ Backend: Python (FastAPI)
  # ----------------------------------------------------------------
  # APIã‚µãƒ¼ãƒãƒ¼ãŠã‚ˆã³ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rpg-backend
    restart: on-failure
    ports:
      - "8000:8000" # é–‹ç™ºç”¨: Swagger UI (http://localhost:8000/docs) ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
    volumes:
      - ./backend:/app # ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å³åº§ã«åæ˜ 
      - ./logs/app:/var/log/app
    environment:
      DATABASE_URL: postgresql+asyncpg://${DB_USER:-user}:${DB_PASSWORD:-password}@db:5432/${DB_NAME:-rehab_db}
      ENV: dev
    depends_on:
      db:
        condition: service_healthy
    # é–‹ç™ºãƒ¢ãƒ¼ãƒ‰(--reload)ã§èµ·å‹•
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - rpg-network

  # ----------------------------------------------------------------
  # âš›ï¸ Frontend: React + TypeScript (Vite)
  # ----------------------------------------------------------------
  # UIã‚’æä¾›ã—ã¾ã™ã€‚
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rpg-frontend
    ports:
      - "3000:5173" # ãƒ›ã‚¹ãƒˆã®3000ç•ªã‚’ã‚³ãƒ³ãƒ†ãƒŠã®5173(Viteãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã«è»¢é€
    volumes:
      - ./frontend:/app
      - /app/node_modules # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®node_modulesã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¸Šæ›¸ãã—ãªã„ãŸã‚ã®è¨­å®š
    environment:
      - CHOKIDAR_USEPOLLING=true # Windows/WSLã§ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ¤œçŸ¥æ¼ã‚Œé˜²æ­¢
    # ãƒ›ã‚¹ãƒˆ0.0.0.0ã§èµ·å‹•ã—ãªã„ã¨ã‚³ãƒ³ãƒ†ãƒŠå¤–ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚å¿…é ˆ
    command: npm run dev -- --host
    networks:
      - rpg-network

  # ----------------------------------------------------------------
  # ğŸŒ Nginx: Reverse Proxy
  # ----------------------------------------------------------------
  # æœ¬ç•ªç’°å¢ƒã‚’æ¨¡å€£ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®æŒ¯ã‚Šåˆ†ã‘ã‚’è¡Œã„ã¾ã™ã€‚
  # CORSã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€é–‹ç™ºä¸­ã§ã‚‚ã“ã‚ŒçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
  nginx:
    image: nginx:alpine
    container_name: rpg-nginx
    ports:
      - "80:80" # http://localhost ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./frontend/public/libs:/usr/share/nginx/html/libs # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé…ä¿¡
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - rpg-network

volumes: # ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€å®šç¾©
  db_data: # DBãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

networks: # ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã®é€šä¿¡ç¶²å®šç¾©
  rpg-network:
    driver: bridge