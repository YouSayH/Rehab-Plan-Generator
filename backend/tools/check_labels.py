import sys
import os
from pathlib import Path

# ãƒ‘ã‚¹è¨­å®š: backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ã¦ app ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ã«ã™ã‚‹
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

try:
    from app.schemas.extraction_schemas import (
        PatientExtractionSchema,
        BasicInfoSchema,
        MedicalRiskSchema,
        FunctionalStatusSchema,
        BasicMovementSchema,
        AdlSchema,
        NutritionSchema,
        SocialSchema,
        GoalSettingSchema,
        SignatureSchema
    )
    from app.core.constants import PATIENT_FIELD_LABELS
except ImportError as e:
    print(f"Import Error: {e}")
    print("Run this script from the 'backend' directory or ensure python path is set.")
    sys.exit(1)

def main():
    print("ğŸ” Checking label definition coverage...")

    # 1. ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ã‚­ãƒ¼ãƒã‚’åˆæœŸåŒ–
    # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãŸã‚ã€å¼•æ•°ãªã—ã§åˆæœŸåŒ–å¯èƒ½ã§ã™ï¼ˆPydanticã®default/Optionalè¨­å®šã«ä¾å­˜ï¼‰
    try:
        dummy_schema = PatientExtractionSchema(
            basic=BasicInfoSchema(),
            medical=MedicalRiskSchema(),
            function=FunctionalStatusSchema(),
            basic_movement=BasicMovementSchema(),
            adl=AdlSchema(),
            nutrition=NutritionSchema(),
            social=SocialSchema(),
            goals=GoalSettingSchema(),
            signature=SignatureSchema()
        )
    except Exception as e:
        print(f"âŒ Failed to instantiate schema: {e}")
        sys.exit(1)

    # 2. ãƒ•ãƒ©ãƒƒãƒˆå½¢å¼ã«å¤‰æ›ã—ã¦ã€å…¨ã‚­ãƒ¼ã‚’å–å¾—
    flat_data = dummy_schema.export_to_mapping_format()
    system_keys = set(flat_data.keys())

    # 3. constants.py ã§å®šç¾©æ¸ˆã¿ã®ã‚­ãƒ¼ã‚’å–å¾—
    defined_keys = set(PATIENT_FIELD_LABELS.keys())

    # 4. æ¯”è¼ƒ: ã‚¹ã‚­ãƒ¼ãƒã«ã‚ã‚‹ãŒã€ãƒ©ãƒ™ãƒ«å®šç¾©ãŒãªã„ã‚­ãƒ¼ (Missing)
    missing_labels = system_keys - defined_keys
    
    # 5. æ¯”è¼ƒ: ãƒ©ãƒ™ãƒ«å®šç¾©ã¯ã‚ã‚‹ãŒã€ã‚¹ã‚­ãƒ¼ãƒã«ãªã„ã‚­ãƒ¼ (Unused/Legacy)
    unused_labels = defined_keys - system_keys

    # --- çµæœå‡ºåŠ› ---
    print(f"   Keys in Schema:    {len(system_keys)}")
    print(f"   Keys in Constants: {len(defined_keys)}")

    if missing_labels:
        print("\nâŒ [FAIL] Missing Label Definitions Detected!")
        print("The following keys exist in the system (extraction_schemas.py)")
        print("but are NOT defined in 'constants.py' (PATIENT_FIELD_LABELS):")
        print("-" * 60)
        for k in sorted(missing_labels):
            print(f" - {k}")
        print("-" * 60)
        print("ğŸ‘‰ Action: Add Japanese labels for these keys in 'backend/app/core/constants.py'.")
        sys.exit(1)
    else:
        print("\nâœ… [PASS] All schema keys have corresponding label definitions.")

    if unused_labels:
        print(f"\nâš ï¸  [WARN] Unused Labels Detected ({len(unused_labels)} keys):")
        print("   (These keys exist in constants.py but are not generated by the current schema logic.)")
        # è©³ç´°ãŒè¦‹ãŸã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
        # for k in sorted(unused_labels):
        #     print(f"   - {k}")

if __name__ == "__main__":
    main()